window.magicodes.odataGrid=function(n){function r(n){console.debug("HtmlValue");n.bindingHandlers.htmlValue={init:function(t,i){var r=function(){var n=i(),r=t.innerHTML;n(r)};n.utils.registerEventHandler(t,"keyup",r);n.utils.registerEventHandler(t,"input",r)},update:function(t,i){var r=n.utils.unwrapObservable(i())||"",u=t.innerHTML;r!==u&&(t.innerHTML=r)}}}var i={url:"",onloaded:function(){},bindElement:null,onViewModelCreated:null,keyName:"Id",filterTemplate:null,$orderby:null,pageSize:10,onBound:null,htmlValueBind:!1,addModal:"#addModal",addModel:{},editAfterRender:null},t;this.options=$.extend(i,n);t=this;this.ViewModel=function(){var n=this,r,i;this.gridViewModel={pages:ko.observable([]),dataRows:ko.observableArray([]),pageSize:ko.observable(typeof t.options.pageSize=="undefined"?10:t.options.pageSize),totalCount:ko.observable(0),currentPageIndex:ko.observable(1),pageOptions:ko.observableArray([10,25,50,100])};this.$filter=null;this.$orderby=null;this.$select=null;this.loading=ko.observable(!1);this.formData=ko.observable(null);this.firstLoad=!0;r=t.options.bindElement||document.body;n.loading.subscribe(function(n){n?magicodes.loader.show($(r)):magicodes.loader.close()});this.addItem=function(n){this.items.push(n)};this.nextPage=function(){this.gridViewModel.currentPageIndex()<this.getTotalPages()&&this.gridViewModel.currentPageIndex(this.gridViewModel.currentPageIndex()+1)};this.previousPage=function(){this.gridViewModel.currentPageIndex()>1&&this.gridViewModel.currentPageIndex(this.gridViewModel.currentPageIndex()-1)};this.getTotalPages=function(){var n=this.gridViewModel.totalCount()/this.gridViewModel.pageSize();return Math.floor(n)+(n>Math.floor(n)?1:0)};this.getPagesArr=function(){var i=this.getTotalPages(),u=i>10?10:i,n=this.gridViewModel.currentPageIndex(),t=1,r=u;return n>5&&(i-n>5?(t=n-4,r=n+5):(t=n-9,r=i)),t<1&&(t=1),ko.utils.range(t,r)};this.filter=function(){if(typeof t.options.filterTemplate!="undefined"&&t.options.filterTemplate.length>0){var i=t.options.filterTemplate,r=i.replace(/\{[^\}]+\}/ig,function(n){var t=$(n.substr(1,n.length-2));return"'"+(t.length>0?t.val():"")+"'"});this.$filter=r;n.loadData()}};n.gridViewModel.totalCount.subscribe(function(){});n.gridViewModel.currentPageIndex.subscribe(function(){n.loadData()});n.gridViewModel.pageSize.subscribe(function(){var t=n.getTotalPages();n.gridViewModel.pages(n.getPagesArr());n.gridViewModel.currentPageIndex()>t&&n.gridViewModel.currentPageIndex(1);n.loadData()});this.loadData=function(){var i={$count:!0,$top:this.gridViewModel.pageSize(),$skip:(this.gridViewModel.currentPageIndex()-1)*this.gridViewModel.pageSize()};n.$filter!=null&&(i.$filter=n.$filter);n.$orderby!=null&&(i.$orderby=n.$orderby);n.loading(!0);window.magicodes.api.request("GET",{url:t.options.url,data:i,func:function(t){$.each(t.value,function(n,t){t._selected=ko.observable(!1)});n.gridViewModel.dataRows(t.value);n.gridViewModel.totalCount(t["@odata.count"]);n.gridViewModel.pages(n.getPagesArr());n.loading(!1)}})};this.init=function(){t.options.$orderby&&(n.$orderby=t.options.$orderby);t.options.$select&&(n.$select=t.options.$select);this.loadData();$.isFunction(t.options.inited)&&t.options.inited(t.options,ko)};this.isAllSelected=ko.computed({read:function(){var t=ko.utils.arrayFirst(n.gridViewModel.dataRows(),function(n){return!n._selected()});return t==null},write:function(t){ko.utils.arrayForEach(n.gridViewModel.dataRows(),function(n){n._selected(t)})}});this.removeSelectedRows=function(){var r=n.getSelectedRows(),i;if(r.length==0){magicodes.messager.showWarnMessage("警告","请先选择需要删除的项！");return}i="";$.each(r,function(){i+=eval("v."+t.options.keyName)+"-"});i=i.substr(0,i.length-1);(new magicodes.dialog).bootbox.confirm({message:"确定要删除所选项么？",func:function(){var i=r.length;$.each(r,function(){var url=t.options.url+"("+eval("v."+t.options.keyName)+")";window.magicodes.api.request("DELETE",{url:url,data:{},func:function(){i--;i==0&&(n.gridViewModel.currentPageIndex(1),n.loadData(),magicodes.messager.showInfoMessage("温馨提示","操作成功！"))}})})}})};this.getSelectedRows=function(){return $.grep(n.gridViewModel.dataRows(),function(n){return n._selected()})};this.edit=function(i){n.loading(!0);var r=new magicodes.dialog;window.magicodes.api.request("GET",{url:t.options.url+"("+i+")",data:{},func:function(i){n.loading(!1);var u=typeof t.options.eidtModel=="undefined"?{}:t.options.eidtModel;n.eidtModel=ko.mapping.fromJS($.extend(i,u));r.bootbox.dialog({title:"编辑",message:"<div><\/div>",buttons:{ok:{label:"<i class='ace-icon fa fa-check'><\/i> 确定",className:"btn-sm btn-success",callback:function(){return n.validator&&!n.validator.options.$form.valid()?!1:(window.magicodes.api.request("PUT",{url:t.options.url,data:ko.mapping.toJS(n.eidtModel),func:function(){magicodes.messager.showInfoMessage("温馨提示","保存成功！");bootbox.hideAll();n.loadData();n.loading(!1)},error:function(){n.loading(!1)}}),!1)}},cancel:{label:"取消",className:"btn-sm btn-danger",callback:function(){}}},show:!1,func:function(){r.bootbox.bootbox.on("shown.bs.modal",function(){var i=$(".bootbox-body:eq(0)");ko.renderTemplate("editTemplate",n.eidtModel,{afterRender:function(){n.validator=t.options.editFormId?new magicodes.validator({$form:$("#"+t.options.editFormId)}):new magicodes.validator;$.isFunction(t.options.editAfterRender)&&t.options.editAfterRender(i)}},i.get(0),"replaceChildren")});r.bootbox.bootbox.modal("show")}})},error:function(){n.loading(!1)}})};this.addModel=ko.mapping.fromJS(t.options.addModel);i=$(t.options.addModal);this.add=function(){i.modal("show")};i.find("button[data-action=ok]").on("click",function(){n.loading(!0);magicodes.api.request("POST",{url:t.options.url,data:ko.mapping.toJS(n.addModel),func:function(){n.loading(!1);magicodes.messager.showInfoMessage("温馨提示","创建成功！");i.modal("hide");n.loadData()},error:function(){n.loading(!1)}})});i.find("button[data-action=cancel]").on("click",function(){i.modal("hide")});this.loadData();t.options.onViewModelCreated&&t.options.onViewModelCreated(n,ko)};this.bindingModel=function(){magicodes.getModule("knockoutJs",function(n){t.options.htmlValueBind&&r(n);require(["kk.mapping"],function(i){n.mapping=i;window.ko=n;var r=new t.ViewModel;t.options.bindElement==null?n.applyBindings(r):n.applyBindings(r,t.options.bindElement);t.options.onBound&&t.options.onBound(r,n)})})};this.bindingModel()};
/*
//# sourceMappingURL=odataGrid.min.js.map
*/