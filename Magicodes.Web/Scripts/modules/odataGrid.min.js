window.magicodes.odataGrid=function(n){function i(n){console.debug("HtmlValue");n.bindingHandlers.htmlValue={init:function(t,i){var r=function(){var n=i(),r=t.innerHTML;n(r)};n.utils.registerEventHandler(t,"keyup",r);n.utils.registerEventHandler(t,"input",r)},update:function(t,i){var r=n.utils.unwrapObservable(i())||"",u=t.innerHTML;r!==u&&(t.innerHTML=r)}}}var t={url:"",onloaded:function(){},bindElement:null,onViewModelCreated:null,keyName:"Id",keyType:"string",filterTemplate:null,$orderby:null,pageSize:10,onBound:null,htmlValueBind:!1,addModel:{},editAfterRender:null},that;this.options=$.extend(t,n);that=this;this.ViewModel=function(){var self=this,n;this.gridViewModel={pages:ko.observable([]),dataRows:ko.observableArray([]),pageSize:ko.observable(typeof that.options.pageSize=="undefined"?10:that.options.pageSize),totalCount:ko.observable(0),currentPageIndex:ko.observable(1),pageOptions:ko.observableArray([10,25,50,100])};this.$filter=null;this.$orderby=null;this.$select=null;this.loading=ko.observable(!1);this.formData=ko.observable(null);this.firstLoad=!0;n=that.options.bindElement||document.body;self.loading.subscribe(function(t){t?magicodes.loader.show($(n)):magicodes.loader.close()});this.addItem=function(n){this.items.push(n)};this.nextPage=function(){this.gridViewModel.currentPageIndex()<this.getTotalPages()&&this.gridViewModel.currentPageIndex(this.gridViewModel.currentPageIndex()+1)};this.previousPage=function(){this.gridViewModel.currentPageIndex()>1&&this.gridViewModel.currentPageIndex(this.gridViewModel.currentPageIndex()-1)};this.getTotalPages=function(){var n=this.gridViewModel.totalCount()/this.gridViewModel.pageSize();return Math.floor(n)+(n>Math.floor(n)?1:0)};this.getPagesArr=function(){var i=this.getTotalPages(),u=i>10?10:i,n=this.gridViewModel.currentPageIndex(),t=1,r=u;return n>5&&(i-n>5?(t=n-4,r=n+5):(t=n-9,r=i)),t<1&&(t=1),ko.utils.range(t,r)};this.filter=function(){if(typeof that.options.filterTemplate!="undefined"&&that.options.filterTemplate.length>0){var n=that.options.filterTemplate,t=n.replace(/\{[^\}]+\}/ig,function(n){var t=$(n.substr(1,n.length-2));return"'"+(t.length>0?t.val():"")+"'"});this.$filter=t;self.loadData()}};self.gridViewModel.totalCount.subscribe(function(){});self.gridViewModel.currentPageIndex.subscribe(function(){self.loadData()});self.gridViewModel.pageSize.subscribe(function(){var n=self.getTotalPages();self.gridViewModel.pages(self.getPagesArr());self.gridViewModel.currentPageIndex()>n&&self.gridViewModel.currentPageIndex(1);self.loadData()});this.loadData=function(){var n={$count:!0,$top:this.gridViewModel.pageSize(),$skip:(this.gridViewModel.currentPageIndex()-1)*this.gridViewModel.pageSize()};self.$filter!=null&&(n.$filter=self.$filter);self.$orderby!=null&&(n.$orderby=self.$orderby);self.loading(!0);window.magicodes.api.request("GET",{url:that.options.url,data:n,func:function(n){$.each(n.value,function(n,t){t._selected=ko.observable(!1)});self.gridViewModel.dataRows(n.value);self.gridViewModel.totalCount(n["@odata.count"]);self.gridViewModel.pages(self.getPagesArr());self.loading(!1)}})};this.init=function(){that.options.$orderby&&(self.$orderby=that.options.$orderby);that.options.$select&&(self.$select=that.options.$select);this.loadData();$.isFunction(that.options.inited)&&that.options.inited(that.options,ko)};this.isAllSelected=ko.computed({read:function(){var n=ko.utils.arrayFirst(self.gridViewModel.dataRows(),function(n){return!n._selected()});return n==null},write:function(n){ko.utils.arrayForEach(self.gridViewModel.dataRows(),function(t){t._selected(n)})}});this.removeSelectedRows=function(){var n=self.getSelectedRows(),ids;if(n.length==0){magicodes.messager.showWarnMessage("警告","请先选择需要删除的项！");return}ids="";$.each(n,function(){ids+=eval("v."+that.options.keyName)+"-"});ids=ids.substr(0,ids.length-1);(new magicodes.dialog).bootbox.confirm({message:"确定要删除所选项么？",func:function(){var count=n.length;$.each(n,function(){var url=self.getGetUrl(eval("v."+that.options.keyName));window.magicodes.api.request("DELETE",{url:url,data:{},func:function(){count--;count==0&&(self.gridViewModel.currentPageIndex(1),self.loadData(),magicodes.messager.showInfoMessage("温馨提示","操作成功！"))}})})}})};this.getSelectedRows=function(){return $.grep(self.gridViewModel.dataRows(),function(n){return n._selected()})};this.getQuotes=function(){return that.options.keyType=="string"?"'":""};this.getGetUrl=function(n){return that.options.url+"("+self.getQuotes()+n+self.getQuotes()+")"};this.form=function(n,t,i,r,u){var f=new magicodes.dialog;f.bootbox.dialog({title:n,message:"<div><\/div>",buttons:{ok:{label:"<i class='ace-icon fa fa-check'><\/i> 确定",className:"btn-sm btn-success",callback:function(){return self.validator&&!self.validator.options.$form.valid()?!1:(self.loading(!0),window.magicodes.api.request(i,{url:that.options.url,data:ko.mapping.toJS(t),func:function(){magicodes.messager.showInfoMessage("温馨提示","保存成功！");f.bootbox.hideAll();self.loading(!1);self.loadData()},error:function(){self.loading(!1)}}),!1)}},cancel:{label:"取消",className:"btn-sm btn-danger",callback:function(){}}},show:!1,func:function(){f.bootbox.bootbox.on("shown.bs.modal",function(){var n=$(".bootbox-body:eq(0)");ko.renderTemplate(r,t,{afterRender:function(){self.validator=u?new magicodes.validator({$form:$("#"+u)}):new magicodes.validator;$.isFunction(that.options.editAfterRender)&&that.options.editAfterRender(n)}},n.get(0),"replaceChildren")});f.bootbox.bootbox.modal("show")}})};this.edit=function(n){self.loading(!0);window.magicodes.api.request("GET",{url:self.getGetUrl(n),data:{},func:function(n){self.loading(!1);var t=typeof that.options.eidtModel=="undefined"?{}:that.options.eidtModel;self.eidtModel=ko.mapping.fromJS($.extend(n,t));self.form("编辑",self.eidtModel,"PUT","editTemplate",that.options.editFormId)},error:function(){self.loading(!1)}})};this.add=function(){var n=typeof that.options.addModel=="undefined"?{}:that.options.addModel;self.addModel=ko.mapping.fromJS(n);self.form("新增",self.addModel,"POST","addTemplate",that.options.addFormId)};this.loadData();that.options.onViewModelCreated&&that.options.onViewModelCreated(self,ko)};this.bindingModel=function(){magicodes.getModule("knockoutJs",function(n){that.options.htmlValueBind&&i(n);require(["kk.mapping"],function(t){n.mapping=t;window.ko=n;var i=new that.ViewModel;that.options.bindElement==null?n.applyBindings(i):n.applyBindings(i,that.options.bindElement);that.options.onBound&&that.options.onBound(i,n)})})};this.bindingModel()};
//# sourceMappingURL=odataGrid.min.js.map
