setTimeout(function(){$("body").fadeIn()},500);window.magicodes={isDebug:!1,isMin:!1,modules:[{name:"login",module:"modules/login"},{name:"navs",module:"modules/navs"},{name:"odataGrid",module:"modules/odataGrid"}],getModule:function(name,func,winName){var that=this;require(["jquery"],function(){var m,moduleName,modules;if(winName&&(m=eval("window."+winName),typeof m!="undefined")){$.isFunction(func)&&func(m);return}moduleName=name;modules=$.each(that.modules,function(n,t){if(t.name==name)return moduleName=that.isMin?t.module+".min":t.module,!1});require([moduleName],function(m){$.isFunction(func)&&(winName&&eval("window."+winName+"=m"),func(m))})})}};window.magicodes.messager={showMessage:function(n,t,i,r){var u={title:n,text:t,class_name:i};typeof r!="undefined"&&(typeof r.before_close!="undefined"&&(u.before_close=r.before_close),typeof r.after_open!="undefined"&&(u.after_open=r.after_open));this._addGritter(u)},showInfoMessage:function(n,t,i){this.showMessage(n,t,"gritter-info gritter-light",i)},showErrorMessage:function(n,t,i){this.showMessage(n,t,"gritter-error gritter-light",i)},showWarnMessage:function(n,t,i){this.showMessage(n,t,"gritter-warning gritter-light",i)},removeAll:function(){typeof $.gritter!="undefined"&&$.gritter.removeAll()},_addGritter:function(n){require(["jquery","jquery.gritter"],function(){$.gritter.add(n)})}};window.magicodes.dialog=function(){self=this;this.bootbox={dialog:function(n){self._bootbox(function(t){self.bootbox.bootbox=t.dialog(n);$.isFunction(n.func)&&n.func()})},confirm:function(n){self._bootbox(function(){bootbox.confirm(n.message,function(t){t&&$.isFunction(n.func)&&n.func()})})},hideAll:function(){bootbox.hideAll()}};this._bootbox=function(n){require(["bootbox"],function(t){$.isFunction(n)&&n(t)})};this.colorbox=function(n){self._colorbox(function(){$.colorbox(n)})};this._colorbox=function(n){require(["jq.colorbox"],function(){$.isFunction(n)&&n()})}};window.magicodes.loader={show:function(n){var i=typeof n=="undefined"?$("body"):n,t;$loading=$('<div class="message-loading-overlay"><i class="fa-spin ace-icon fa fa-spinner orange2 bigger-180"><\/i><\/div>').css({"z-index":1e4});i.append($loading);this.$loading=$loading;t=this;t.onShow&&t.onShow()},close:function(){var n=this;n.onClose&&n.onClose();$(".message-loading-overlay").remove()}};window.magicodes.logger={log:function(){var n="[magicodes]"+Array.prototype.join.call(arguments,"");window.console&&window.console.log?window.console.log(n):window.opera&&window.opera.postError&&window.opera.postError(n)}};window.magicodes.api={request:function(n,t){switch(n.toUpperCase()){case"GET":case"DELETE":this._sendRequest({url:t.url,type:n,data:t.data,func:t.func,error:t.error});break;case"POST":case"PUT":this._sendRequest({url:t.url,type:n,data:JSON.stringify(t.data),func:t.func,error:t.error});break;default:this._sendRequest({url:t.url,type:n,data:t.data,func:t.func,error:t.error})}},_sendRequest:function(n){$.ajax({url:n.url,type:n.type,data:n.data,cache:!1,accepts:"application/json",dataType:"json",contentType:"application/json; charset=utf-8",statusCode:{200:function(t){$.isFunction(n.func)&&n.func(t,200)},201:function(t){$.isFunction(n.func)&&n.func(t,201)},401:function(){window.location.href="/Login"},204:function(t){$.isFunction(n.func)&&n.func(t,204)},400:function(t){var i=$.parseJSON(t.responseText),r,u,f;if(!$.isFunction(n.error)||!n.error(i,400))if(i.error)r=i.error.innererror&&i.error.innererror.message?i.error.innererror.message:i.error.message,magicodes.messager.showErrorMessage("错误",r.replace(/\r\n/gi,"<br />"));else if(i.ModelState){r=i.Message;u="<br />";for(f in i.ModelState)u+=i.ModelState[f]+"<br />";magicodes.messager.showErrorMessage("错误",r.replace(/\r\n/gi,"<br />")+u)}},500:function(t){var i=$.parseJSON(t.responseText),r;$.isFunction(n.error)&&n.error(i,400)||(i.error?(r=i.error.innererror&&i.error.innererror.message?i.error.innererror.message:i.error.message,magicodes.messager.showErrorMessage("操作失败",r.replace(/\r\n/gi,"<br />"))):i.Message?(r=i.Message,magicodes.messager.showErrorMessage("操作失败",r.replace(/\r\n/gi,"<br />"))):i.message&&(r=i.message,magicodes.messager.showErrorMessage("操作失败",r.replace(/\r\n/gi,"<br />"))))}}}).fail(function(n){var t=$.parseJSON(n.responseText);console.error(t)})}};window.magicodes.validator=function(n){var t=this,i={errorElement:"div",errorClass:"help-block",focusInvalid:!1,highlight:function(n){$(n).closest(".input-control").removeClass("success-state").addClass("error-state");$(n).closest(".form-group").removeClass("has-info").addClass("has-error")},success:function(n){$(n).closest(".input-control").removeClass("error-state").addClass("success-state");$(n).closest(".form-group").removeClass("has-error").addClass("has-info");$(n).remove()},errorPlacement:function(n,t){if(t.is("input[type=checkbox]")||t.is("input[type=radio]")){var i=t.closest("div.CheckBoxListBorder");i.find(":checkbox,:radio").length>1?i.append(n):n.insertAfter(t.nextAll(".lbl:eq(0)").eq(0))}else t.is(".select2")?n.insertAfter(t.siblings('[class*="select2-container"]:eq(0)')):t.is(".chosen-select")?n.insertAfter(t.siblings('[class*="chosen-container"]:eq(0)')):n.insertAfter(t.parent())},invalidHandler:function(n,t){var i=t.numberOfInvalids();i&&(t.errorList[0].element.focus(),magicodes.messager.showWarnMessage("警告","您有 "+i+" 个字段填写不符合要求，请根据下面的提示语进行修正。"))},$form:$("form"),initComplete:function(){}};t.options=$.extend(i,n);require(["jq.validation"],function(){t.options.$form.find("textarea[required],input[required],select[required]").each(function(){var t=$(this),n=t.closest(".form-group:not([hideRequired])").find("label:eq(0)");n||(n=t.closest(".input-control").prev("label"));n.find(".text-warning").length==0&&n.append('<span class="text-warning">*<\/span>')});jQuery.validator.addMethod("password",function(n,t){return this.optional(t)||n.length>=6&&/\d/.test(n)&&/[a-z]/i.test(n)},"密码必须大于6个字符并且至少涵盖一个数字和字母！");t.options.$form.validate(t.options);$.isFunction(t.options.initComplete)&&t.options.initComplete()})};window.magicodes.grid={init:function(setting){require(["knockoutJs"],function(n){n.bindingHandlers.htmlValue={init:function(t,i){var r=function(){var n=i(),r=t.innerHTML;n(r)};n.utils.registerEventHandler(t,"keyup",r);n.utils.registerEventHandler(t,"input",r)},update:function(t,i){var r=n.utils.unwrapObservable(i())||"",u=t.innerHTML;r!==u&&(t.innerHTML=r)}};var i=function(){var self=this;this.addItem=function(n){this.items.push(n)};this.nextPage=function(){this.gridViewModel.currentPageIndex()<this.getTotalPages()&&this.gridViewModel.currentPageIndex(this.gridViewModel.currentPageIndex()+1)};this.previousPage=function(){this.gridViewModel.currentPageIndex()>1&&this.gridViewModel.currentPageIndex(this.gridViewModel.currentPageIndex()-1)};this.getTotalPages=function(){var n=this.gridViewModel.totalCount()/this.gridViewModel.pageSize();return Math.floor(n)+(n>Math.floor(n)?1:0)};this.getPagesArr=function(){var r=this.getTotalPages(),f=r>10?10:r,t=this.gridViewModel.currentPageIndex(),i=1,u=f;return t>5&&(r-t>5?(i=t-4,u=t+5):(i=t-9,u=r)),i<1&&(i=1),n.utils.range(i,u)};this.gridViewModel={pages:n.observable([]),dataRows:n.observableArray([]),pageSize:n.observable(typeof setting.pageSize=="undefined"?10:setting.pageSize),totalCount:n.observable(0),currentPageIndex:n.observable(1),pageOptions:n.observableArray([10,25,50,100])};this.$filter=null;this.$orderby=null;this.$select=null;this.filter=function(){if(typeof setting.filterTemplate!="undefined"&&setting.filterTemplate.length>0){var n=setting.filterTemplate,t=n.replace(/\{[^\}]+\}/ig,function(n){var t=$(n.substr(1,n.length-2));return"'"+(t.length>0?t.val():"")+"'"});this.$filter=t;self.loadData()}};self.gridViewModel.totalCount.subscribe(function(){});self.gridViewModel.currentPageIndex.subscribe(function(){self.loadData()});self.gridViewModel.pageSize.subscribe(function(){var n=self.getTotalPages();self.gridViewModel.pages(self.getPagesArr());self.gridViewModel.currentPageIndex()>n&&self.gridViewModel.currentPageIndex(1);self.loadData()});this.loadData=function(){var t={$count:!0,$top:this.gridViewModel.pageSize(),$skip:(this.gridViewModel.currentPageIndex()-1)*this.gridViewModel.pageSize()};self.$filter!=null&&(t.$filter=self.$filter);self.$orderby!=null&&(t.$orderby=self.$orderby);magicodes.loader.show($(setting.gridId));window.magicodes.api.request("GET",{url:setting.url,data:t,func:function(t){$.each(t.value,function(t,i){i._selected=n.observable(!1)});self.gridViewModel.dataRows(t.value);self.gridViewModel.totalCount(t["@odata.count"]);self.gridViewModel.pages(self.getPagesArr());magicodes.loader.close()}})};this.init=function(){setting.$orderby&&(self.$orderby=setting.$orderby);setting.$select&&(self.$select=setting.$select);this.loadData();$.isFunction(setting.inited)&&setting.inited(setting,n)};this.isAllSelected=n.computed({read:function(){var t=n.utils.arrayFirst(self.gridViewModel.dataRows(),function(n){return!n._selected()});return t==null},write:function(t){n.utils.arrayForEach(self.gridViewModel.dataRows(),function(n){n._selected(t)})}});this.edit=function(t){var i=new magicodes.dialog;window.magicodes.api.request("GET",{url:setting.url+"("+t+")",data:{},func:function(t){var r=typeof setting.eidtModel=="undefined"?{}:setting.eidtModel;self.eidtModel=n.observable($.extend(t,r));i.bootbox.dialog({title:"编辑",message:"<div><\/div>",buttons:{ok:{label:"<i class='ace-icon fa fa-check'><\/i> 确定",className:"btn-sm btn-success",callback:function(){return self.validator&&!self.validator.options.$form.valid()?!1:(window.magicodes.api.request("PUT",{url:setting.url,data:self.eidtModel(),func:function(n,t){console.debug(t);magicodes.messager.showInfoMessage("温馨提示","保存成功！");bootbox.hideAll();self.loadData();console.debug(n)}}),!1)}},cancel:{label:"取消",className:"btn-sm btn-danger",callback:function(){}}},show:!1,func:function(){i.bootbox.bootbox.on("shown.bs.modal",function(){n.renderTemplate("editTemplate",self.eidtModel,{afterRender:function(){self.validator=setting.editFormId?new magicodes.validator({$form:$("#"+setting.editFormId)}):new magicodes.validator;$.isFunction(setting.afterEditDialogShow)&&setting.afterEditDialogShow()}},$(".bootbox-body:eq(0)").get(0),"replaceChildren")});i.bootbox.bootbox.modal("show")}})}})};this.removeSelectedRows=function(){var n=self.getSelectedRows(),ids;if(n.length==0){magicodes.messager.showWarnMessage("警告","请先选择需要删除的项！");return}ids="";$.each(n,function(){ids+=eval("v."+setting.keyName)+"-"});ids=ids.substr(0,ids.length-1);(new magicodes.dialog).bootbox.confirm({message:"确定要删除所选项么？",func:function(){var count=n.length;$.each(n,function(){var url=setting.url+"("+eval("v."+setting.keyName)+")";window.magicodes.api.request("DELETE",{url:url,data:{},func:function(){count--;count==0&&(self.gridViewModel.currentPageIndex(1),self.loadData(),magicodes.messager.showInfoMessage("温馨提示","操作成功！"))}})})}})};this.getSelectedRows=function(){return $.grep(self.gridViewModel.dataRows(),function(n){return n._selected()})};this.add=function(){var t=new magicodes.dialog,i=typeof setting.addModel=="undefined"?{}:setting.addModel;this.addModel=n.observable($.extend({},i));t.bootbox.dialog({title:"新增",message:"<div><\/div>",buttons:{ok:{label:"<i class='ace-icon fa fa-check'><\/i> 确定",className:"btn-sm btn-success",callback:function(){return self.validator&&!self.validator.options.$form.valid()?!1:(window.magicodes.api.request("POST",{url:setting.url,data:self.addModel(),func:function(){magicodes.messager.showInfoMessage("温馨提示","创建成功！");bootbox.hideAll();self.loadData()}}),!1)}},cancel:{label:"取消",className:"btn-sm btn-danger",callback:function(){}}},show:!1,func:function(){t.bootbox.bootbox.on("shown.bs.modal",function(){n.renderTemplate("addTemplate",self.addModel,{afterRender:function(){self.validator=setting.editFormId?new magicodes.validator({$form:$("#"+setting.editFormId)}):new magicodes.validator;$.isFunction(setting.afterEditDialogShow)&&setting.afterEditDialogShow()}},$(".bootbox-body:eq(0)").get(0),"replaceChildren")});t.bootbox.bootbox.modal("show")}})}},t=new i;n.applyBindings(t);$(function(){t.init()})})}};window.magicodes.form=function(n){var i={reloadAfterSave:!1,api:"",onloaded:function(){},enterSave:!0,loadData:!0,bindElement:null,saveMethod:"PUT",onsaved:null,onsave:null,onViewModelCreated:null,onsaveError:null},t;this.options=$.extend(i,n);t=this;this.ViewModel=function(){var n=this,i;this.loading=ko.observable(!1);this.formData=ko.observable(null);this.firstLoad=!0;i=t.options.bindElement||document.body;n.loading.subscribe(function(n){n?magicodes.loader.show($(i)):magicodes.loader.close()});this.load=function(){n.loading(!0);magicodes.api.request("GET",{url:t.options.api,func:function(i){n.loading(!1);n.formData(i);n.firstLoad&&(n.firstLoad=!1,$.isFunction(t.options.onloaded)&&t.options.onloaded(i))},error:function(){n.loading(!1)}})};this.save=function(){if(n.validator&&!n.validator.options.$form.valid())return!1;(!t.options.onsave||t.options.onsave())&&(n.loading(!0),magicodes.api.request(t.options.saveMethod,{url:t.options.api,data:n.formData(),func:function(i,r){if(n.loading(!1),t.options.onsaved)t.options.onsaved(i,r,n);else magicodes.messager.showInfoMessage("温馨提示","保存成功！");t.options.reloadAfterSave&&n.formData(i)},error:function(i,r){return(n.loading(!1),t.options.onsaveError&&t.options.onsaveError(i,r))?!0:!1}}))};t.options.onViewModelCreated&&t.options.onViewModelCreated(n);n.validator=new magicodes.validator;t.options.loadData&&n.load();t.options.enterSave&&$(i).keypress(function(t){var i=t.which?t.which:t.keyCode;return i===13?($(this).find(":focus").trigger("blur"),n.save(),!1):!0})};this.bindingModel=function(){magicodes.getModule("knockoutJs",function(n){t.options.bindElement==null?n.applyBindings(new t.ViewModel):n.applyBindings(new t.ViewModel,t.options.bindElement)},"ko")}};
//# sourceMappingURL=magicodes.min.js.map
